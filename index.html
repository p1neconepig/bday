<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANO MAS PIPILIIN MO? HEHE</title>
    
    <!-- Load Tailwind CSS for beautiful styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FONT: Poppins (Geometric, Open, Balanced) -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">

    <!-- Custom Tailwind Configuration for the specified palette -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'custom-light': '#F9F3F3',  // Very Light Pink/Off-White
              'custom-soft': '#F7D9D9',   // Soft Pink
              'custom-dark': '#F25287',   // Deep Rose/Pink Accent
              'custom-gray': '#DDDDDD',  // Light Gray/Gray Accent
            }
          }
        }
      }
    </script>
    
    <style>
        /* Custom styles to ensure the container takes up the full viewport height */
        body {
            /* Now using Poppins */
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            
            /* Solid background color */
            background-color: #F7D9D9; /* custom-soft */
            
            position: relative; 
            overflow-y: auto;
        }
        
        /* Custom button styling for hover effects */
        .choice-button {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .choice-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        
        /* Connections Game Styles */
        .word-tile {
            min-height: 70px; /* Ensure tiles are a decent size on mobile */
            cursor: pointer;
            transition: all 0.15s;
            user-select: none;
            border-bottom: 4px solid rgba(0, 0, 0, 0.1);
        }
        .word-tile:hover:not(.selected):not(.guessed) {
            background-color: #fcebeb; /* Lighter soft pink on hover */
        }
        .word-tile.selected {
            background-color: #f0a3b8; /* Darker pink for selected state */
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .word-tile.guessed {
            pointer-events: none; /* Cannot be clicked after guessed */
            box-shadow: none;
            border-bottom: none;
            opacity: 1; /* Reset opacity in case of other effects */
            display: flex; /* Centers the content */
            align-items: center;
            justify-content: center;
        }
        .word-tile.guessed .category-name {
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Main Game Container: max-w-xl (wider) and p-10/p-12 (taller/more padding) for rectangular shape -->
    <div id="game-container" class="w-full max-w-xl h-auto bg-custom-light rounded-3xl p-10 sm:p-12 shadow-2xl transition-all duration-500 transform scale-100 relative"> 
        
        <!-- HEADER (Shared) -->
        <h1 id="main-header" class="text-3xl sm:text-4xl font-extrabold text-center text-custom-dark mb-4 tracking-tight">
            ANO MAS PIPILIIN MO? HEHEHE 
        </h1>

        <!-- --- 1. WOULD YOU RATHER GAME AREA --- -->
        <div id="wyr-game-area">
            <p id="progress-text" class="text-center text-sm text-gray-500 mb-8"></p>

            <!-- Question Area -->
            <div id="question-area">
                <!-- Question Text box uses custom-soft background (#F7D9D9) -->
                <div class="mb-8 p-4 bg-custom-soft rounded-xl border-2 border-custom-dark/50">
                    <p id="question-text" class="text-xl sm:text-2xl font-semibold text-gray-700 text-center">
                        Loading your personalized scenario...
                    </p>
                </div>

                <!-- Choices -->
                <div class="space-y-4">
                    <!-- Choice A kept indigo for strong contrast -->
                    <button id="btn-choice-a" class="choice-button w-full p-4 text-white font-bold rounded-xl text-lg sm:text-xl bg-indigo-500 hover:bg-indigo-600 active:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                        Option A
                    </button>
                    <div class="text-center text-lg font-bold text-gray-500 pt-2">â€” OR â€”</div>
                    <!-- Choice B uses custom-dark accent color (#F25287) -->
                    <button id="btn-choice-b" class="choice-button w-full p-4 text-white font-bold rounded-xl text-lg sm:text-xl bg-custom-dark hover:bg-rose-700 active:bg-rose-800 focus:outline-none focus:ring-4 focus:ring-custom-dark/50">
                        Option B
                    </button>
                </div>
            </div>

            <!-- Result/Toast Message Area -->
            <div id="result-message" class="mt-8 p-4 rounded-xl bg-yellow-100 text-yellow-800 border border-yellow-300 hidden transition-all duration-300">
                <p id="result-content" class="text-center text-base font-medium"></p>
            </div>

            <!-- Action Area (Now only holds the Next Button) -->
            <div id="action-area" class="mt-6 text-center hidden space-y-4">
                <button id="btn-next-question" class="w-full px-6 py-3 bg-custom-gray text-gray-700 font-semibold rounded-full hover:bg-custom-soft focus:outline-none focus:ring-4 focus:ring-custom-gray/50">
                    Next
                </button>
            </div>
            
        </div>
        <!-- --- END WYR GAME AREA --- -->
        
        <!-- --- 2. CONNECTIONS GAME AREA --- -->
        <div id="connections-game-container" class="hidden">
            <h2 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-2">Connections</h2>
            <p class="text-center text-gray-600 mb-6">YOU KNOW THE RULES</p>

            <div id="word-grid" class="grid grid-cols-4 gap-2 mb-6">
                <!-- Word Tiles will be injected here -->
            </div>

                <div id="connections-controls" class="hidden sm:flex sm:space-x-4 space-y-4 sm:space-y-0">
                    <button id="btn-deselect-all" class="w-full sm:w-1/2 p-3 bg-custom-gray text-gray-700 font-semibold rounded-lg hover:bg-custom-soft">
                        Deselect All
                    </button>
                    <button id="btn-submit-group" class="choice-button w-full sm:w-1/2 p-3 text-white font-bold rounded-lg bg-custom-dark hover:bg-rose-700 disabled:opacity-50" disabled>
                        Submit Group (0/4)
                    </button>
                </div>

            <div id="connections-message" class="mt-4 p-3 rounded-lg text-center font-medium hidden">
                <!-- Messages (Success/Failure) will appear here -->
            </div>

            <!-- NEW BLOCK: Connections Win State (Intermediate Screen) -->
            <div id="connections-win-message" class="mt-8 p-6 bg-green-100 border border-green-300 rounded-xl text-center hidden">
                <h3 class="text-xl font-bold text-green-800 mb-4">Congratulations! ðŸŽ‰</h3>
                <p class="text-gray-700 mb-4">Graduate ka na ng Grade 2!</p>
                <button id="btn-show-final-prize" class="choice-button w-full px-6 py-3 bg-custom-dark text-white font-semibold rounded-lg hover:bg-rose-700 focus:outline-none focus:ring-4 focus:ring-custom-dark/50">
                    NEXT
                </button>
            </div>

        </div>
        <!-- --- END CONNECTIONS GAME AREA --- -->

        <!-- --- 3. FINAL FINISH SCREEN (True End: Missed Links List) --- -->
        <div id="final-finish-screen" class="text-center hidden p-8 bg-custom-light rounded-xl">
            <svg class="w-20 h-auto mx-auto mb-4 text-custom-dark" fill="currentColor" stroke="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">I love you!</h2>
            <p class="text-lg text-gray-600 mb-6">Since di ako madamot ito na yung hindi mo napiling option kanina.</p>
            
            <!-- Container for Missed Links -->
            <div id="missed-links-container" class="space-y-4 max-h-60 overflow-y-auto text-left p-4 bg-white rounded-lg shadow-inner border border-custom-gray">
                <!-- Links will be dynamically injected here -->
                <p class="text-center text-gray-500 italic">...Processing links...</p>
            </div>

            <!-- The only button on the final screen is to restart -->
            <button id="btn-restart-all" class="w-full sm:w-auto px-6 py-3 mt-8 bg-custom-dark text-white font-semibold rounded-lg hover:bg-rose-700 focus:outline-none focus:ring-4 focus:ring-custom-dark/50">
                Play Again?
            </button>
        </div>
        
    </div>
    
<script>
        
        // --- DATA SECTION: WYR Scenarios ---
        const scenarios = [
            {
                a: "Cast any spell from the Harry Potter Series?",
                b: "Pick any Quirk from My Hero Academia?",
                answerA: "LAME",
                answerB: "LAME",
            },            
            {
                a: "Magsuot ng minion costume buong buhay mo?",
                b: "Ako magsusuot ng minion costume buong buhay ko?",
                answerA: "HAHAHAHAHA",
                answerB: "HAHAHAHAHA",
            },
            {
                a: "Never mo na ulit ako makikita ðŸ™„",
                b: "Never ka na pwede mag socks ðŸ˜‹",
                answerA: "MAS PIPILIIN MO PA MEDYAS KAY SA SAKIN",
                answerB: "BEST ANSWER",
            },
            {
                a: "Spotify playlist that I made for you",
                b: "Song cover na I made for you",
                answerA: "k. di mo na pwede makuha yung isa. https://tinyurl.com/yenplaylist.",
                answerB: "k. di mo na pwede makuha yung isa. This one doesn't have a link.",
            },
            {
                a: "Cy ðŸ™„",
                b: "Gibsson ðŸ™„",
                answerA: "WRONG ANSWER",
                answerB: "WRONG ANSWER",
            }
        ];
        // --- END WYR DATA SECTION ---

        // --- DATA SECTION: CONNECTIONS GAME ---
        // IMPORTANT: Customize these 4 categories and 16 words with your own inside jokes and memories!
        const connectionsData = {
            // Mapping categories to unique colors for display
            colorMap: {
                "YOUR SECOND FAVE PEOPLE AFTER ME ðŸ˜ˆ": "bg-red-500",
                "YENCYCLOPEDIA OF KNOWN ULAM NAMES": "bg-blue-500",
                "10/10 Nicknames": "bg-green-500",
                "YOU ARE MY _____": "bg-pink-500"
            },
            categories: [
                { name: "YOUR SECOND FAVE PEOPLE AFTER ME ðŸ˜ˆ", words: ["Jill", "Ellie", "Tikoy", "Camille"] },
                { name: "YENCYCLOPEDIA OF KNOWN ULAM NAMES", words: ["Gulay", "Chicken", "Pork", "Fish"] },
                { name: "10/10 Nicknames", words: ["Yenyen", "ERYLICIOUS", "Yennifer", "DEBL"] },
                { name: "YOU ARE MY _____", words: ["fave", "bff", "wife", "EVERYTHING!"] }
            ]
        };
        // --- END CONNECTIONS DATA SECTION ---

         const finalPrizeContent = {
            title: "HAPPY BIRTHDAY DIANE ERYL!!",
            subtitle: "You successfully completed the journey! All the links below are for you, sweetheart.",
            manualLinks: [
                {
                    name: "Grade 2 Graduation Photo:",
                    url: "https://imgur.com/a/DdLMLCo",
                    description: "GALING GALING NAMAN HAHAHAHAHA."
                }
                // --- NEW MANUAL LINK EXAMPLE (It will now display!) ---
                // Add more links here by copying the structure: { name: "...", url: "...", description: "..." }
            ],
            missedLinksHeader: "Graduation Gifts HAHAHAHA:"
        };
        // --- END FINAL PRIZE LINKS DATA SECTION ---

        let currentScenarioIndex = 0;
        let lastChoice = ''; // Stores the last chosen option ('A' or 'B')
        const chosenAnswers = []; // Array to track user's choice ('A' or 'B') for each scenario index

        // Connections Game State
        let allWords = []; 
        let selectedWords = [];
        let guessedCategories = 0;

        // Get DOM elements
        const mainHeader = document.getElementById('main-header');
        const wyrGameArea = document.getElementById('wyr-game-area');
        const questionText = document.getElementById('question-text');
        const btnChoiceA = document.getElementById('btn-choice-a');
        const btnChoiceB = document.getElementById('btn-choice-b');
        const progressText = document.getElementById('progress-text');
        const resultMessage = document.getElementById('result-message');
        const resultContent = document.getElementById('result-content');
        const questionArea = document.getElementById('question-area');
        const actionArea = document.getElementById('action-area');
        const btnNextQuestion = document.getElementById('btn-next-question'); 
        
        // Connections Elements
        const connectionsGameContainer = document.getElementById('connections-game-container');
        const wordGrid = document.getElementById('word-grid');
        const btnDeselectAll = document.getElementById('btn-deselect-all');
        const btnSubmitGroup = document.getElementById('btn-submit-group');
        const connectionsMessage = document.getElementById('connections-message');
        const connectionsWinMessage = document.getElementById('connections-win-message');
        const btnShowFinalPrize = document.getElementById('btn-show-final-prize');
        const finalFinishScreen = document.getElementById('final-finish-screen');
        const btnRestartAll = document.getElementById('btn-restart-all');
        const missedLinksContainer = document.getElementById('missed-links-container');


        // --- UTILITY FUNCTIONS ---

        // Simple Fisher-Yates shuffle
        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // Utility to find and replace URLs with clickable anchor tags
        function makeLinksClickable(text) {
            // Guard against null/undefined input (like the previous error)
            if (typeof text !== 'string') {
                return { text: '', hasLink: false };
            }
            
            // Regex for common URL formats (http/https and tinyurl with alphanumeric paths)
            const urlRegex = /(\bhttps?:\/\/[^\s]+|\btinyurl\.com\/[a-zA-Z0-9_-]+)\b/g;

            let hasLink = false;
            // The text.replace will execute the callback function for every match
            const linkedText = text.replace(urlRegex, (match) => {
                hasLink = true;
                // Strip trailing period if present, so the link target is clean
                const url = match.replace(/\.$/, ''); 
                
                // Return the HTML anchor tag
                return `
                    <a href="${url}" target="_blank" rel="noopener noreferrer" 
                       class="text-blue-600 hover:text-blue-800 underline font-medium break-all transition duration-150">
                        ${url}
                    </a>
                `;
            });

            return { text: linkedText, hasLink: hasLink };
        }


        // --- WOULD YOU RATHER GAME LOGIC ---
        
        function nextQuestion() {
            currentScenarioIndex++;
            loadScenario();
        }

        function loadScenario() {
            if (currentScenarioIndex < scenarios.length) {
                const scenario = scenarios[currentScenarioIndex];
                questionText.textContent = `Isa lang pwede lol`;
                btnChoiceA.textContent = scenario.a;
                btnChoiceB.textContent = scenario.b;
                progressText.textContent = `Question ${currentScenarioIndex + 1} of ${scenarios.length}`;
                
                // Reset UI for new WYR question
                resultMessage.classList.add('hidden');
                actionArea.classList.add('hidden');

                // Ensure default result colors are set for the next question
                resultMessage.classList.remove('bg-green-100', 'text-gray-800', 'border-green-300');
                resultMessage.classList.add('bg-yellow-100', 'text-yellow-800', 'border-yellow-300');


                wyrGameArea.classList.remove('hidden');
                connectionsGameContainer.classList.add('hidden');
                finalFinishScreen.classList.add('hidden');
                mainHeader.textContent = "ANO MAS PIPILIIN MO? HEHEHE";
                
                btnChoiceA.disabled = false;
                btnChoiceB.disabled = false;
                btnChoiceA.classList.remove('opacity-50');
                btnChoiceB.classList.remove('opacity-50');

            } else {
                // Game over, transition to Connections Game
                showConnectionsGame();
            }
        }

        function handleChoice(choice) {
            lastChoice = choice;
            const scenario = scenarios[currentScenarioIndex];
            
            // Record the user's choice for this index
            chosenAnswers[currentScenarioIndex] = choice;

            // Determine the raw answer content
            const rawAnswerContent = (choice === 'A') ? scenario.answerA : scenario.answerB;

            // Process content for clickable links
            const { text: processedText, hasLink } = makeLinksClickable(rawAnswerContent);

            // Clear styling
            resultMessage.classList.remove('bg-yellow-100', 'text-yellow-800', 'border-yellow-300', 'bg-green-100', 'text-gray-800', 'border-green-300');

            if (hasLink) {
                // If a link was detected and replaced, use innerHTML and green/success styling
                resultContent.innerHTML = `<span class="block text-center">${processedText}</span>`;
                resultMessage.classList.add('bg-green-100', 'text-gray-800', 'border-green-300');
            } else {
                // If no link, use safe textContent and default yellow styling
                resultContent.textContent = rawAnswerContent;
                resultMessage.classList.add('bg-yellow-100', 'text-yellow-800', 'border-yellow-300');
            }

            // Display the result message
            resultMessage.classList.remove('hidden');

            // Show the action area (Next Question button)
            actionArea.classList.remove('hidden');

            // Disable choice buttons after selecting
            btnChoiceA.disabled = true;
            btnChoiceB.disabled = true;
            btnChoiceA.classList.add('opacity-50');
            btnChoiceB.classList.add('opacity-50');
        }

        // --- CONNECTIONS GAME LOGIC ---

        function initializeConnectionsData() {
            allWords = [];
            connectionsData.categories.forEach(cat => {
                cat.words.forEach(word => {
                    allWords.push({ 
                        word: word, 
                        category: cat.name, 
                        color: connectionsData.colorMap[cat.name],
                        isGuessed: false 
                    });
                });
            });
            // Shuffle the words for the grid
            shuffle(allWords);
        }

        function loadConnectionsGrid() {
            wordGrid.innerHTML = '';
            
            // First, filter out and group the already guessed words to display them first
            const guessedItems = allWords.filter(item => item.isGuessed);
            const remainingItems = allWords.filter(item => !item.isGuessed);

            // Re-sort guessed items to group by category name for display consistency
            const sortedGuessedCategories = connectionsData.categories
                .filter(cat => guessedItems.some(item => item.category === cat.name))
                .map(cat => ({
                    name: cat.name,
                    color: connectionsData.colorMap[cat.name],
                    words: cat.words
                }));

            // Display guessed categories first
            sortedGuessedCategories.forEach(cat => {
                const categoryTile = document.createElement('div');
                categoryTile.className = `word-tile guessed text-white p-2 rounded-xl text-lg col-span-4 transition-all duration-300 ${cat.color}`;
                categoryTile.innerHTML = `
                    <div class="text-xs font-semibold uppercase opacity-90">${cat.name}</div>
                    <div class="text-base font-bold italic ml-2">(${cat.words.join(', ')})</div>
                `;
                wordGrid.appendChild(categoryTile);
            });

            // Display remaining clickable tiles
            remainingItems.forEach((item, index) => {
                const tile = document.createElement('div');
                // Use the word itself as a key/id for easier tracking, since we shuffle
                tile.id = `word-tile-${item.word.replace(/\s/g, '-')}`; 
                tile.className = `word-tile bg-white text-gray-800 p-2 rounded-xl text-center text-sm sm:text-base font-semibold transition-all duration-150 shadow`;
                tile.textContent = item.word;
                tile.addEventListener('click', () => handleWordClick(item.word, tile));
                
                // Add 'selected' class if the word is currently selected
                if (selectedWords.includes(item.word)) {
                    tile.classList.add('selected');
                }

                wordGrid.appendChild(tile);
            });
        }
        
        function handleWordClick(word, tile) {
            if (tile.classList.contains('guessed')) return;

            const isSelected = selectedWords.includes(word);

            if (isSelected) {
                // Deselect
                selectedWords = selectedWords.filter(w => w !== word);
                tile.classList.remove('selected');
            } else if (selectedWords.length < 4) {
                // Select
                selectedWords.push(word);
                tile.classList.add('selected');
            } else {
                // Too many selected
                showMessage("You can only select 4 words!", 'error');
            }

            // Update submit button state
            updateSubmitButton();
        }

        function updateSubmitButton() {
            const count = selectedWords.length;
            btnSubmitGroup.textContent = `Submit Group (${count}/4)`;
            btnSubmitGroup.disabled = count !== 4;
        }

        function checkSubmission() {
            if (selectedWords.length !== 4) return;

            // Determine the category of the selected words
            const categoriesInSelection = new Set();
            selectedWords.forEach(word => {
                const item = allWords.find(w => w.word === word);
                if (item) categoriesInSelection.add(item.category);
            });

            // If only one category is present, it's a correct guess
            const isCorrect = categoriesInSelection.size === 1;

            if (isCorrect) {
                const targetCategoryName = selectedWords
                    .map(word => allWords.find(w => w.word === word).category)
                    .find((value, index, self) => self.indexOf(value) === index); // Find the unique category name
                
                const targetCategory = connectionsData.categories.find(c => c.name === targetCategoryName);
                
                handleCorrectGuess(targetCategoryName, targetCategory.color);
            } else {
                handleIncorrectGuess();
            }
        }
        
        function handleCorrectGuess(categoryName, categoryColor) {
            showMessage(`Correct! Category Found: ${categoryName}`, 'success');
            guessedCategories++;

            // Mark words as guessed and update their status in the allWords array
            selectedWords.forEach(word => {
                const item = allWords.find(w => w.word === word);
                if (item) item.isGuessed = true;
            });

            // Clear selections
            selectedWords = [];
            updateSubmitButton();

            // Re-render the grid to replace the 4 tiles with the category tile
            setTimeout(loadConnectionsGrid, 500); // Small delay for visual satisfaction

            if (guessedCategories === connectionsData.categories.length) {
                // All solved! Show the intermediate win screen with the next button
                showConnectionsWinScreen();
            }
        }
        
        function handleIncorrectGuess() {
            showMessage("Not quite! Try another group of 4.", 'error');

            // Flash the tiles briefly to indicate error
            selectedWords.forEach(word => {
                // Find the element by the word, filtering for non-guessed tiles
                const tileElement = document.getElementById(`word-tile-${word.replace(/\s/g, '-')}`);

                if (tileElement) {
                    tileElement.classList.add('ring-4', 'ring-red-400', 'animate-pulse');
                    setTimeout(() => {
                        tileElement.classList.remove('ring-4', 'ring-red-400', 'animate-pulse');
                    }, 500);
                }
            });
        }

        function showMessage(text, type) {
            connectionsMessage.textContent = text;
            connectionsMessage.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
            if (type === 'success') {
                connectionsMessage.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                connectionsMessage.classList.add('bg-red-100', 'text-red-800');
            }
            setTimeout(() => {
                connectionsMessage.classList.add('hidden');
            }, 3000);
        }

        function deselectAllWords() {
            // Find all currently selected tile elements and deselect them visually
            selectedWords.forEach(word => {
                const tileElement = document.getElementById(`word-tile-${word.replace(/\s/g, '-')}`);
                if (tileElement) {
                    tileElement.classList.remove('selected');
                }
            });
            selectedWords = [];
            updateSubmitButton();
        }

        // --- SCREEN TRANSITIONS ---

        function showConnectionsGame() {
            mainHeader.textContent = "GRADE 2 FINAL EXAM";
            wyrGameArea.classList.add('hidden');
            finalFinishScreen.classList.add('hidden');
            connectionsGameContainer.classList.remove('hidden');

            // Ensure controls are visible when game starts
            wordGrid.classList.remove('hidden');
            document.getElementById('connections-controls').classList.remove('hidden');
            connectionsWinMessage.classList.add('hidden'); // Hide the win message initially

            initializeConnectionsData();
            loadConnectionsGrid();
        }

        function showConnectionsWinScreen() {
            // *FIXED*: Keep the wordGrid visible to show the solved categories (removed wordGrid.classList.add('hidden')).
            // Only hide the controls since the game is over.
            document.getElementById('connections-controls').classList.add('hidden');
            connectionsMessage.classList.add('hidden');
            
            // Show the win message and the "Go to Final Prize" button
            connectionsWinMessage.classList.remove('hidden');
        }

        function showFinalPrizeScreen() {
            // 1. Calculate and display the missed links
            generateMissedLinks();

            // 2. Transition screens
            connectionsGameContainer.classList.add('hidden');
            finalFinishScreen.classList.remove('hidden');
            mainHeader.textContent = "HAPPY BIRTHDAY DIANESKIE!";
        }
        
        // Function to extract the unchosen links and display manual links (UPDATED)
        function generateMissedLinks() {
            missedLinksContainer.innerHTML = ''; // Clear previous content
            let foundWYRLinks = 0; // Tracks links from WYR section
            
            // --- STEP 1: ADD MANUAL LINKS HEADER ---
            const headerItem = document.createElement('div');
            headerItem.className = 'p-3 text-center bg-white rounded-lg shadow-inner border border-custom-dark/30 mb-4';
            headerItem.innerHTML = `<h3 class="text-xl font-bold text-custom-dark">${finalPrizeContent.missedLinksHeader}</h3>`;
            missedLinksContainer.appendChild(headerItem);
            
            // --- STEP 2: ADD MANUAL LINKS (unconditional gifts) ---
            finalPrizeContent.manualLinks.forEach(linkObj => {
                const linkItem = document.createElement('div');
                // Green background for the unconditional gifts
                linkItem.className = 'p-3 bg-green-100 border border-green-300 rounded-lg shadow-sm mb-3';
                
                // Use makeLinksClickable utility to turn the URL string into an <a> tag
                const { text: linkedUrl } = makeLinksClickable(linkObj.url); 
                
                linkItem.innerHTML = `
                    <p class="font-semibold text-green-800 mb-1">${linkObj.name}</p>
                    <p class="text-sm text-gray-700">${linkObj.description}</p>
                    <p class="text-sm mt-1">${linkedUrl}</p>
                `;
                missedLinksContainer.appendChild(linkItem);
            });


            // --- STEP 3: DYNAMICALLY CALCULATE MISSED WYR LINKS ---
            // Iterate through all scenarios to find the *uncylod* options with links
            scenarios.forEach((scenario, index) => {
                const chosen = chosenAnswers[index];
                
                let rawAnswerContent = null;
                let choiceText = null;
                
                // Determine the answer content that was *not* chosen
                if (chosen === 'A' && scenario.answerB) {
                    rawAnswerContent = scenario.answerB;
                    choiceText = scenario.b;
                } else if (chosen === 'B' && scenario.answerA) {
                    rawAnswerContent = scenario.answerA;
                    choiceText = scenario.a;
                }
                
                if (rawAnswerContent) {
                    // Use the utility function to find links
                    const { text: linkedText, hasLink } = makeLinksClickable(rawAnswerContent);

                    if (hasLink) {
                        foundWYRLinks++;
                        const linkItem = document.createElement('div');
                        // Soft pink background for the dynamic missed links
                        linkItem.className = 'p-3 bg-custom-soft rounded-lg shadow-sm mb-3'; 
                        linkItem.innerHTML = `
                            <p class="font-semibold text-gray-700 mb-1">Missed Option Gift: <span class="text-custom-dark">${choiceText}</span></p>
                            <p class="text-sm">${linkedText}</p>
                        `;
                        missedLinksContainer.appendChild(linkItem);
                    }
                }
            });

            // --- STEP 4: MESSAGE IF NO WYR LINKS WERE MISSED ---
            if (foundWYRLinks === 0) {
                const noMissedLinksMessage = document.createElement('p');
                noMissedLinksMessage.className = 'text-center text-gray-500 italic p-4';
                noMissedLinksMessage.textContent = 'You chose all the options that contained a hidden link/gift! There are no extra missed links to display.';
                missedLinksContainer.appendChild(noMissedLinksMessage);
            }
        }

        function restartAll() {
            // Reset WYR state
            currentScenarioIndex = 0;
            lastChoice = '';
            chosenAnswers.length = 0; // Clear the choices array
            
            // Reset Connections state
            allWords = [];
            selectedWords = [];
            guessedCategories = 0;
            
            // Start over
            loadScenario();
        }


        // --- INITIALIZATION AND EVENT LISTENERS ---

        // WYR Listeners
        btnChoiceA.addEventListener('click', () => handleChoice('A'));
        btnChoiceB.addEventListener('click', () => handleChoice('B'));
        btnNextQuestion.addEventListener('click', nextQuestion);

        // Connections Listeners
        btnDeselectAll.addEventListener('click', deselectAllWords);
        btnSubmitGroup.addEventListener('click', checkSubmission);
        btnShowFinalPrize.addEventListener('click', showFinalPrizeScreen); // Listener for the intermediate screen
        btnRestartAll.addEventListener('click', restartAll);
        
        // Start the game on load
        window.onload = loadScenario;
    </script>
</body>
</html>


